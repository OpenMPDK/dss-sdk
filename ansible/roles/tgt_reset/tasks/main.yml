---

- name: Kill Nvmf target
  shell: "ps -ef | grep [n]vmf_tgt | awk '{ print $2 }' | xargs kill -9 "
  ignore_errors: true

- name: Unload SPDK
  shell: "sh {{ product_dir }}/scripts/setup.sh reset"
  ignore_errors: true

- name: Ensure etcd & other services are stopped
  service:
    name: "{{ item }}"
    state: stopped
    enabled: no
  with_items:
    - etcd-gateway
    - etcd
  ignore_errors: true

- name: Delete etcd data directory
  file: path={{ etcd_data_dir }} state=absent

- name: Delete etcd.conf
  file: path=/etc/etcd/etcd.conf state=absent

- name: Remove ntp, keepalived and haproxy packages
  package:
    name: "{{ item }}"
    state: absent
  with_items: 
    - FM-Agent
    - NKV
    - etcd
    - haproxy
    - keepalived
  ignore_errors: true

- name: Ensure haproxy directory is removed
  file: path={{ item }} state=absent
  with_items:
    - "/etc/haproxy"
    - "/var/lib/haproxy"
    - "/etc/keepalived"
  ignore_errors: true

- name: Delete etcd services
  file: path=/etc/systemd/system/{{ item }}.service state=absent
  with_items:
    - etcd-gateway
    - etcd-proxy
    - etcd
  ignore_errors: true

- name: Delete previous paths
  shell: "sed -i /{{ item }}/d ~/.bashrc"
  with_items:
    - PYTHONPATH
    - PATH
    - ETCDCTL_API
  ignore_errors: true

- name: Delete dragonfly source, log and config directories
  file: path={{ item }} state=absent
  with_items:
    - "{{ product_dir }}"
    - "{{ config_file_dir }}"
    - "{{ nkv_agent_config_file_dir }}"
    - "{{ logfile_dir }}"
    - "{{ dfly_temp_dir }}"
    - /tmp/install_packages.py
    - /tmp/upgrade_packages.py
    - /tmp/subsystem_add.py
