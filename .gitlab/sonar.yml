sonar-scanner:
  stage: scan
  before_script:
    # Download sonar-scanner from URL defined in CICD variable SONAR_SCANNER_URL
    - export SONAR_SCANNER_FILENAME="${SONAR_SCANNER_URL##*/}"
    - curl --silent --remote-name $SONAR_SCANNER_URL
    # Get sonar-scanner root dir from printed contents of zip file
    - export SONAR_SCANNER_DIR=$(unzip -l "$SONAR_SCANNER_FILENAME" | awk '{print $4}' | grep '/' | cut -d '/' -f 1 | sort | uniq -c | sort -nr | head -n 1 | awk '{print $2}')
    - unzip -q $SONAR_SCANNER_FILENAME -d /
  script:
    # Scan with sonar-scanner
    - /$SONAR_SCANNER_DIR/bin/sonar-scanner  -Dsonar.qualitygate.wait=true -Dsonar.cfamily.build-wrapper-output=bw-output -Dsonar.coverageReportPaths=$SONAR_UNIT_TEST_REPORT
  allow_failure: true
  needs:
    - build dss-sdk
    - target unit test
  variables:
    GIT_DEPTH: 0
    SONAR_UNIT_TEST_REPORT: df_out/reports/sonar_qube_ut_coverage_report.xml
  rules:
    - !reference [.default_rules, merge_and_push]
