From b0e66797e0efc19899a7c49720fa4a913bbcd941 Mon Sep 17 00:00:00 2001
From: rama kavuluru <r.kavuluru@msl-ssg-mp03.msl.lab>
Date: Thu, 23 Jun 2022 13:56:54 -0700
Subject: [PATCH] [rocksdb-build] Added support for debug/release builds

Signed-off-by: rama kavuluru <r.kavuluru@msl-ssg-mp03.msl.lab>
---
 Makefile | 30 ++++++++++++++++++++++++------
 1 file changed, 24 insertions(+), 6 deletions(-)

diff --git a/Makefile b/Makefile
index 0c6c4c0..e21b575 100644
--- a/Makefile
+++ b/Makefile
@@ -10,6 +10,7 @@ BASH_EXISTS := $(shell which bash)
 SHELL := $(shell which bash)
 
 CLEAN_FILES = # deliberately empty, so we can append below.
+#CFLAGS += ${EXTRA_CFLAGS} -fsanitize=address
 CFLAGS += ${EXTRA_CFLAGS}
 CXXFLAGS += ${EXTRA_CXXFLAGS}
 LDFLAGS += $(EXTRA_LDFLAGS)
@@ -43,6 +44,7 @@ quoted_perl_command = $(subst ','\'',$(perl_command))
 # Set the default DEBUG_LEVEL to 1
 DEBUG_LEVEL?=1
 
+
 ifeq ($(MAKECMDGOALS),dbg)
 	DEBUG_LEVEL=2
 endif
@@ -87,9 +89,21 @@ ifeq ($(MAKECMDGOALS),rocksdbjavastaticpublish)
 	DEBUG_LEVEL=0
 endif
 
+ifdef DEBUG_MODE_BUILD
+	DEBUG_LEVEL=2
+endif
+
+ifdef RELEASE_MODE_BUILD
+	DEBUG_LEVEL=0
+endif
+
 # compile with -O2 if debug level is not 2
-ifneq ($(DEBUG_LEVEL), 2)
+ifeq ($(DEBUG_LEVEL), 1)
+
 OPT += -O2 -fno-omit-frame-pointer
+#OPT += -g -fno-omit-frame-pointer
+
+
 # Skip for archs that don't support -momit-leaf-frame-pointer
 ifeq (,$(shell $(CXX) -fsyntax-only -momit-leaf-frame-pointer -xc /dev/null 2>&1))
 OPT += -momit-leaf-frame-pointer
@@ -107,6 +121,8 @@ endif
 
 #-----------------------------------------------
 include src.mk
+SPDK_DIR ?= ../spdk
+SPDK_ROOT_DIR := $(abspath $(SPDK_DIR))
 
 AM_DEFAULT_VERBOSITY = 0
 
@@ -140,6 +156,9 @@ LDFLAGS += -lrados
 endif
 
 AM_LINK = $(AM_V_CCLD)$(CXX) $^ $(EXEC_LDFLAGS) -o $@ $(LDFLAGS) $(COVERAGEFLAGS)
+
+include $(SPDK_ROOT_DIR)/lib/rocksdb/spdk.rocksdb.mk
+
 # detect what platform we're building on
 dummy := $(shell (export ROCKSDB_ROOT="$(CURDIR)"; export PORTABLE="$(PORTABLE)"; "$(CURDIR)/build_tools/build_detect_platform" "$(CURDIR)/make_config.mk"))
 # this file is generated by the previous line to set build flags and sources
@@ -505,11 +524,7 @@ BENCHMARKS = db_bench table_reader_bench cache_bench memtablerep_bench column_aw
 # if user didn't config LIBNAME, set the default
 ifeq ($(LIBNAME),)
 # we should only run rocksdb in production with DEBUG_LEVEL 0
-ifeq ($(DEBUG_LEVEL),0)
-        LIBNAME=librocksdb
-else
-        LIBNAME=librocksdb_debug
-endif
+	LIBNAME=librocksdb
 endif
 LIBRARY = ${LIBNAME}.a
 TOOLS_LIBRARY = ${LIBNAME}_tools.a
@@ -942,6 +957,9 @@ librocksdb_env_basic_test.a: env/env_basic_test.o $(LIBOBJECTS) $(TESTHARNESS)
 db_bench: tools/db_bench.o $(BENCHTOOLOBJECTS)
 	$(AM_LINK)
 
+rdb_spdk_simple: tools/rdb_spdk_simple.o $(LIBOBJECTS)
+	$(AM_LINK)
+
 cache_bench: cache/cache_bench.o $(LIBOBJECTS) $(TESTUTIL)
 	$(AM_LINK)
 
-- 
1.8.3.1

